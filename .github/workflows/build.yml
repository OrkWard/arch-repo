name: Build Packages

on:
  push:
    branches: [master]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm base-devel git sudo
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          useradd -m builder

      - name: Checkout
        uses: actions/checkout@v4

      - name: Build packages
        run: |
          mkdir -p x86_64
          chown -R builder:builder .
          
          su builder -c '
            cd "$HOME"
            
            # Build berry from AUR
            git clone --depth 1 https://aur.archlinux.org/berry.git
            cd berry && makepkg -s --noconfirm && cp *.pkg.tar.zst "$GITHUB_WORKSPACE/x86_64/"
            cd "$HOME"
            
            # Build alttab from AUR
            git clone --depth 1 https://aur.archlinux.org/alttab.git
            cd alttab && makepkg -s --noconfirm && cp *.pkg.tar.zst "$GITHUB_WORKSPACE/x86_64/"
            cd "$HOME"
            
            # Build czmod from local PKGBUILD
            mkdir czmod && cd czmod
            cp "$GITHUB_WORKSPACE/PKGBUILDs/czmod/PKGBUILD" .
            makepkg -s --noconfirm
            cp *.pkg.tar.zst "$GITHUB_WORKSPACE/x86_64/"
          '

      - name: Update database
        run: |
          cd x86_64
          repo-add orkward.db.tar.gz *.pkg.tar.zst

      - name: Deploy to gh-pages
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Create orphan gh-pages branch if not exists
          git fetch origin gh-pages 2>/dev/null || true
          
          # Create temp directory for deployment
          mkdir -p /tmp/deploy
          cp x86_64/* /tmp/deploy/
          
          # Switch to gh-pages branch
          git checkout --orphan gh-pages 2>/dev/null || git checkout gh-pages
          
          # Clean and copy new files
          rm -rf *
          cp /tmp/deploy/* .
          
          git add -A
          git commit -m "Update packages $(date -u +%Y-%m-%d)" || echo "No changes"
          git push origin gh-pages --force
