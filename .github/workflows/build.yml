name: Build Packages

on:
  push:
    branches: [master]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm base-devel git sudo
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          useradd -m builder

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pages
        uses: actions/configure-pages@v4

      - name: Build packages
        run: |
          mkdir -p x86_64
          chown -R builder:builder .
          
          su builder -c '
            cd "$HOME"
            
            # Build berry from AUR
            git clone --depth 1 https://aur.archlinux.org/berry.git
            cd berry && makepkg -s --noconfirm && cp *.pkg.tar.zst "$GITHUB_WORKSPACE/x86_64/"
            cd "$HOME"
            
            # Build alttab from AUR
            git clone --depth 1 https://aur.archlinux.org/alttab.git
            cd alttab && makepkg -s --noconfirm && cp *.pkg.tar.zst "$GITHUB_WORKSPACE/x86_64/"
            cd "$HOME"
            
            # Build czmod from local PKGBUILD
            mkdir czmod && cd czmod
            cp "$GITHUB_WORKSPACE/PKGBUILDs/czmod/PKGBUILD" .
            makepkg -s --noconfirm
            cp *.pkg.tar.zst "$GITHUB_WORKSPACE/x86_64/"
          '

      - name: Update database
        run: |
          cd x86_64
          repo-add orkward.db.tar.gz *.pkg.tar.zst

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
